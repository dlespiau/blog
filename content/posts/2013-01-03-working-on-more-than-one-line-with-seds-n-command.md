+++
title = "Working on more than one line with sed's 'N' command"
date = 2013-01-03T14:24:00Z
updated = 2016-02-06T18:33:28Z
tags = ["misc", "Unix"]
blogimport = true 
[author]
	name = "Damien Lespiau"
	uri = "https://plus.google.com/114288295280403017038"
+++

<div dir="ltr" style="text-align: left;" trbidi="on">Yesterday I was asked to help solving a small <code>sed</code> problem. Considering that file (don't look too closely on the engineering of the defined elements):<br /><div><pre class="brush: text; gutter: true">&lt;root&gt;<br />  &lt;key&gt;key0&lt;/key&gt;<br />  &lt;string&gt;value0&lt;/string&gt;<br />  &lt;key&gt;key1&lt;/key&gt;<br />  &lt;string&gt;value1&lt;/string&gt;<br />  &lt;key&gt;key2&lt;/key&gt;<br />  &lt;string&gt;value2&lt;/string&gt;<br />&lt;/root&gt;</pre><div>The problem was: How to change <code>value1</code> to <code>VALUE!</code>. The problem here is that you can't blindly execute a <code>s</code> command matching<code> &lt;string&gt;.*&lt;/string&gt;</code>.<br />Sed maintains a buffer called the "pattern space" and processes commands on this buffer. From the GNU sed manual:<br /><blockquote>sed operates by performing the following cycle on each line of input: first, sed reads one line from the input stream, removes any trailing newline, and places it in the pattern space. Then commands are executed; each command can have an address associated to it: <a href="http://www.gnu.org/software/sed/manual/sed.html#Addresses" title="sed addresses">addresses</a> are a kind of condition code, and a command is only executed if the condition is verified before the command is to be executed.<br /><br />When the end of the script [(list of sed commands)] is reached, unless the -n option is in use, the contents of pattern space are printed out to the output stream, adding back the trailing newline if it was removed.3 Then the next cycle starts for the next input line.</blockquote>So the idea is to first, use a <code>/pattern/</code> address to select the the right &lt;key&gt; line, append the next line to the pattern space (with the <a href="http://www.gnu.org/software/sed/manual/sed.html#Other-Commands">N command</a>) and finally run a s command on the buffer now containing both lines:<br /><pre class="brush: text; gutter: true">&lt;key&gt;key1&lt;/key&gt;<br />  &lt;string&gt;value1&lt;/string&gt;</pre>And so we end up with:<br /><pre class="brush: text; gutter: true">$ cat input <br />&lt;root&gt;<br />  &lt;key&gt;key0&lt;/key&gt;<br />  &lt;string&gt;value0&lt;/string&gt;<br />  &lt;key&gt;key1&lt;/key&gt;<br />  &lt;string&gt;value1&lt;/string&gt;<br />  &lt;key&gt;key2&lt;/key&gt;<br />  &lt;string&gt;value2&lt;/string&gt;<br />&lt;/root&gt;<br />$ sed -e '/&lt;key&gt;key1&lt;\/key&gt;/{N;s#&lt;string&gt;.*&lt;\/string&gt;#&lt;string&gt;VALUE!&lt;\/string#;}' &lt; input <br />&lt;root&gt;<br />  &lt;key&gt;key0&lt;/key&gt;<br />  &lt;string&gt;value0&lt;/string&gt;<br />  &lt;key&gt;key1&lt;/key&gt;<br />  &lt;string&gt;VALUE!&lt;/string<br />  &lt;key&gt;key2&lt;/key&gt;<br />  &lt;string&gt;value2&lt;/string&gt;<br />&lt;/root&gt;</pre></div></div></div>
