+++
title = "shave: making the autotools output sane"
date = 2009-02-18T17:54:00Z
updated = 2016-02-07T14:08:31Z
tags = ["cool hacks"]
blogimport = true 
[author]
	name = "Damien Lespiau"
	uri = "https://plus.google.com/114288295280403017038"
+++

<span style="color: #ff0000;">updated</span><span style="color: #ff0000;">:</span> Automake 1.11 has been release with "silent rules" support, a feature that supersedes the hack that shave is. If you can depend on automake 1.11 please consider using its silent rules rather than shave.<br /><span style="color: #ff0000;">updated:</span> add some gtk-doc info<br /><span style="color: #ff0000;">updated:</span> CXX support thanks to Tommi Komulainen<br /><br /><h3>shave</h3><br />Fed up with endless screens of libtool/automake output? Fed up with having to resort to -Werror to see warnings in your code? Then shave might be for you. shave transforms the messy output of autotools into a pretty Kbuild-like one (Kbuild is the Linux build system). It's composed of a m4 macro and 2 small shell scripts and it's available in a <a title="shave git repository" href="http://git.lespiau.name/cgit/shave/">git repository</a>.<br /><pre class="brush: text; gutter: true">git clone git://git.lespiau.name/shave</pre>Hopefully, in a few minutes, you should be able to see your project compile like this:<br /><pre class="brush: text; gutter: true">$ make<br />Making all in foo<br />Making all in internal<br />CC    internal-file0.o<br />LINK  libinternal.la<br />CC    lib-file0.o<br />CC    lib-file1.o<br />LINK  libfoo.la<br />Making all in tools<br />CC    tool0-tool0.o<br />LINK  tool0</pre>Just like Kbuild, shave supports outputting the underlying commands using:<br /><pre class="brush: text; gutter: true">$ make V=1</pre><br /><h3>Setup</h3><br /><ul><li>Put the two shell scripts shave.in and shave-libtool.in in the directory of your choice (it can be at the root of your autotooled project).</li><li>add shave and shave-libtool to AC_CONFIG_FILES</li><li>add shave.m4 either in acinclude.m4 or your macro directory</li><li>add a call to SHAVE_INIT just before AC_CONFIG_FILES/AC_OUTPUT. SHAVE_INIT takes one argument, the directory where shave and shave-libtool are.</li></ul><br /><h3>Custom rules</h3><br />Sometimes you have custom Makefile rules, e.g. to generate a small header, run glib-mkenums or glib-genmarshal. It would be nice to output a pretty 'GEN' line. That's quite easy actually, just add few (portable!) lines at the top of your Makefile.am:<br /><pre class="brush: text; gutter: true">V         = @<br />Q         = $(V:1=)<br />QUIET_GEN = $(Q:@=@echo &#039;  GEN   &#039;$@;)</pre>and then it's just a matter of prepending $(QUIET_GEN) to the rule creating the file:<br /><pre class="brush: text; gutter: true">lib-file2.h: Makefile<br />$(QUIET_GEN)echo &quot;#define FOO_DEFINE 0xbabe&quot; &gt; lib-file2.h</pre><br /><h3>gtk-doc + shave</h3><br />gtk-doc + shave + libtool 1.x (2.x is fine) is known to have a small issue, <a title="bug #572396" href="http://bugzilla.gnome.org/show_bug.cgi?id=572396">a patch</a> is available. Meanwhile I suggest adding a few lines to your autogen.sh script.<br /><pre class="brush: text; gutter: true">sed -e &#039;s#) --mode=compile#) --tag=CC --mode=compile#&#039; gtk-doc.make &gt; gtk-doc.temp \<br />&amp;&amp; mv gtk-doc.temp gtk-doc.make<br />sed -e &#039;s#) --mode=link#) --tag=CC --mode=link#&#039; gtk-doc.make &gt; gtk-doc.temp \<br />&amp;&amp; mv gtk-doc.temp gtk-doc.make</pre><br /><h3>dolt + shave</h3><br />It's possible to use <a title="dolt" href="http://dolt.freedesktop.org/">dolt</a> in conjunction with shave with a <a title="patch to make dolt work with shave" href="http://git.lespiau.name/cgit/dolt/commit/?h=shave-dolt">surprisingly small patch</a> to dolt.<br /><h3>Real world example: Clutter</h3><br /><pre class="brush: text; gutter: true">$ make<br />GEN   stamp-clutter-marshal.h<br />GEN   clutter-marshal.c<br />GEN   stamp-clutter-enum-types.h<br />Making all in cogl<br />Making all in common<br />CC    cogl-util.o<br />CC    cogl-bitmap.o<br />CC    cogl-bitmap-fallback.o<br />CC    cogl-primitives.o<br />CC    cogl-bitmap-pixbuf.o<br />CC    cogl-clip-stack.o<br />CC    cogl-fixed.o<br />CC    cogl-color.o<br />cogl-color.c: In function ‘cogl_set_source_color4ub’:<br />cogl-color.c:141: warning: implicit declaration of function ‘cogl_set_source_color’<br />CC    cogl-vertex-buffer.o<br />CC    cogl-matrix.o<br />CC    cogl-material.o<br />LINK  libclutter-cogl-common.la<br />[...]</pre><br />Eh! now we can see a warning there!<br /><br /><h3>TODO</h3><br />This is a first release, shave has not been widely tested aka it may not work for you!<br /><ul><li>test it with a wider range of automake/libtool versions</li><li>shave won't work without AC_CONFIG_HEADERS due to shell quoting problems</li><li>see what can be done for make install/dist (they are prettier thanks to make -s, but we probably miss a few actions)</li><li>there is a '-s' hardcoded in MAKEFLAGS,  I have to find a way to make it more flexible</li></ul>
