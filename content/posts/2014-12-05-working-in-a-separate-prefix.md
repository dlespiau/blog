+++
title = "Working in a separate prefix"
date = 2014-12-05T18:00:00Z
updated = 2016-02-06T12:27:42Z
tags = ["misc", "Unix"]
blogimport = true 
[author]
	name = "Damien Lespiau"
	uri = "https://plus.google.com/114288295280403017038"
+++

<div dir="ltr" style="text-align: left;" trbidi="on">I've been surprised in the past to discover that even some seasoned engineers didn't know how to use the autotools prefix feature. A sign they've been lucky enough and didn't have to deal with Autotools too much. Here's my attempt to provide some introduction to <code>./configure --prefix</code>.<br /><br />Working with or in "a separate prefix" is working with libraries and binaries (well, anything produced by '<code>make install</code>' in an autotooled project really) installed in a different directory than the system-wide ones (/usr or even /usr/local that can become quite messy). It is the preferred way to hack on a full stack without polluting your base distribution and has several advantages:<br /><ul><li>One&nbsp;can hack on the whole stack without the fear of not being able to run your desktop environment you're working with if something goes wrong,</li><li>More often than not, one needs a relatively recent library that your distribution doesn't ship with (say a recent libdrm). When working with the dependencies in a prefix, it's just a matter of recompiling it.</li></ul><br />Let's take an example to make the discussion easier:<br /><ul style="text-align: left;"><li>&nbsp;We want to compile libdrm and intel-gpu-tools (because intel-gpu-needs needs a more recent libdrm than the one coming with your distribution),</li><li>&nbsp;We want to use the <code>~/gfx</code> directory for our work,</li><li>git trees with be cloned in <code>~/gfx/sources</code>,</li><li><code>~/gfx/install</code> is chosen as the prefix.</li></ul><br />First, let's clone the needed git repositories:<br /><pre class="brush: bash; gutter: false">$ mkdir -p ~/gfx/sources ~/gfx/install<br />$ cd ~/gfx/sources<br />$ git clone git://anongit.freedesktop.org/mesa/drm libdrm<br />$ git clone git://anongit.freedesktop.org/xorg/app/intel-gpu-tools</pre>Then you need to source a script that will set-up your environment with a few variables to tell the system to use the prefix (both at run-time and compile-time). A minimal version of that script for our example is (I store my per-project setup scripts to source at the root of the project, in our case ~/gfx):<br /><pre class="brush: bash; gutter: false">$ cat ~/gfx/setup-env<br />PROJECT=~/gfx<br />export PATH=$PROJECT/install/bin:$PATH<br />export LD_LIBRARY_PATH=$PROJECT/install/lib:$LD_LIBRARY_PATH<br />export PKG_CONFIG_PATH=$PROJECT/install/lib/pkgconfig:$PKG_CONFIG_PATH<br />export ACLOCAL_FLAGS="-I $PROJECT/install/share/aclocal $ACLOCAL_FLAG"<br />$ source ~/gfx/setup-env</pre>Then it's time to compile libdrm, telling the <code>configure</code> script that we want to install it in in our prefix:<br /><pre class="brush: bash; gutter: false">$ cd ~/gfx/sources/libdrm<br />$ ./autogen.sh --prefix=/home/damien/gfx/install<br />$ make<br />$ make install</pre>Note that you don't need to run "sudo make install" since we'll be installing in our prefix directory that is writeable by the current user.<br /><br />Now it's time to compile i-g-t:<br /><pre class="brush: bash; gutter: false">$ cd ~/gfx/sources/intel-gpu-tools<br />$ ./autogen.sh --prefix=/home/damien/gfx/install<br />$ make<br />$ make install</pre>The configure script may complain about dependencies (eg. cairo, SWIG,...). Different ways to solve those:<br /><ul style="text-align: left;"><li>For dependencies not directly linked with the graphics stack (like SWIG), it's recommended to use the development package provided by the distribution</li><li>For old enough dependencies that don't change very often (like cairo) you can use the distribution development package or compile them in your prefix</li><li>For dependencies more recent than your distribution ones, you need to install them in the chosen prefix.</li></ul></div>
