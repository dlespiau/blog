+++
title = "Using glib.py and gobject.py GDB scripts"
date = 2010-03-23T20:58:00Z
updated = 2016-02-07T14:02:22Z
tags = ["GNOME"]
blogimport = true 
[author]
	name = "Damien Lespiau"
	uri = "https://plus.google.com/114288295280403017038"
+++

<div dir="ltr" style="text-align: left;" trbidi="on">Some time ago, Alexander Larson blogged about <a href="http://blogs.gnome.org/alexl/2009/09/21/archer-gdb-macros-for-glib/">using gdb python macros</a> when debugging Glib and GObject projects. I've wanted to try those for ages, so I spent part of the week-end looking at what you could do with the new python enabled GDB, result: quite a lot of neat stuff!<br /><br />Let's start by making the script that now comes with glib work on stock gdb 7.0 and 7.1 (ie not the archer branch that contains more of the python work). If those two scripts don't work for you yet (because your distribution is not packaging them, or is packaging a stock gdb 7.0. 7.1), here are a few hints you can follow:<br /><ul><li>glib's GDB macros rely on GDB's auto-load feature, ie, every time GDB load a library your program uses, it'll look for a corresponding python script to execute:</li></ul><pre class="brush: text; gutter: true">open("/lib/libglib-2.0.so.0.2200.4-gdb.py", O_RDONLY)<br />open("/usr/lib/debug/lib/libglib-2.0.so.0.2200.4-gdb.py", O_RDONLY)<br />open("/usr/share/gdb/auto-load/lib/libglib-2.0.so.0.2200.4-gdb.py", O_RDONLY)</pre>Some distributions have decided not to ship glib's and gobject's auto-load helpers, if you are in that case, you'd need to load <code>gobject.py</code> and <code>glib.py</code> by hand. For that purpose I've added a small python command in my <code>~/.gdbinit</code>:<br /><pre class="brush: python; gutter: true">import os.path<br />import sys<br />import gdb<br /><br /># Update module path.<br />dir = os.path.join(os.path.expanduser("~"), ".gdb")<br />if not dir in sys.path:<br />    sys.path.insert(0, dir)<br /><br />class RegisterCommand (gdb.Command):<br />"""Register GLib and GObject modules"""<br /><br />    def __init__ (self):<br />        super (RegisterCommand, self).__init__ ("gregister",<br />                                                gdb.COMMAND_DATA,<br />                                                gdb.COMPLETE_NONE)<br /><br />    def invoke (self, arg, from_tty):<br />        objects = gdb.objfiles ()<br />        for object in objects:<br />            if object.filename.find ("libglib-2.0.so.") != -1:<br />                from glib import register<br />                register (object)<br />            elif object.filename.find ("libgobject-2.0.so.") != -1:<br />                from gobject import register<br />                register (object)<br /><br />RegisterCommand ()<br /></pre>What I do is put <code>glib.py</code> and <code>gobject.py</code> in a<code> ~/.gdb</code> directory and don't forget to call <code>gregister</code> inside GDB (once gdb has loaded glib and gobject)<br /><ul><li>The scripts that are inside glib's repository were written with the archer branch of gdb (which bring all the python stuff). Unfortunately stock GDB (7.0 and 7.1) does not have everything the archer gdb has. I have a <a href="https://bugzilla.gnome.org/show_bug.cgi?id=613732">couple</a> of <a href="https://bugzilla.gnome.org/show_bug.cgi?id=613736">patches</a> to fix that in the queue. Meanwhile you can grab them in <a href="http://git.lespiau.name/cgit/sk/tree/dotfiles/gdb">my survival kit repository</a>. This will disable the back trace filters as they are still not in stock GDB.</li></ul><br />You're all set! it's time to enjoy pretty printing and <code>gforeach</code>. Hopefully people will join the fun at some point and add more GDB python macro goodness both inside glib and in other projects (for instance a ClutterActor could print its name).<br /><pre class="brush: c; gutter: true">int main (int argc, char **argv)<br />{<br />glist = g_list_append (glist, "first");<br />glist = g_list_append (glist, "second");<br /><br />return breeeaaak_oooon_meeeee ();<br />}</pre>gives:<br /><pre class="brush: text; gutter: true">(gdb) b breeeaaak_oooon_meeeee<br />Breakpoint 1 at 0x80484b7: file glib.c, line 9.<br />(gdb) r<br />Starting program: /home/damien/src/test-gdb/glib<br />Breakpoint 1, breeeaaak_oooon_meeeee () at glib.c:9<br />9&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return 0;<br />(gdb) gregister<br />(gdb) gforeach s in glistp: print ((char *)$s)<br />No symbol "glistp" in current context.<br />(gdb) gforeach s in glist: print ((char *)$s)<br />$2 = 0x80485d0 "first"<br />$3 = 0x80485d6 "second"</pre></div>
